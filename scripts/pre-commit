#!/bin/bash
# Pre-commit hook for ODAI SDK
# Runs format check and lint on staged C/C++ files

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

# Get staged C/C++ files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(cpp|h|c)$' | grep '^src/' || true)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

echo "Running pre-commit checks on staged files..."

# Convert to absolute paths
FILES=""
for f in $STAGED_FILES; do
    FILES="$FILES $PROJECT_ROOT/$f"
done

# Check formatting
echo "Checking format..."
if ! "$PROJECT_ROOT/scripts/format.sh" --check $FILES; then
    echo ""
    echo "❌ Format check failed. Run: ./scripts/format.sh --all"
    exit 1
fi

# Run lint (warnings only, don't block commits)
echo "Running lint..."
"$PROJECT_ROOT/scripts/lint.sh" $FILES || true

echo "✓ Pre-commit checks passed!"
